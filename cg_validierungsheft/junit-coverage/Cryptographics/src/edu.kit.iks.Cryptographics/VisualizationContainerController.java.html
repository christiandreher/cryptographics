<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../.resources/report.gif" type="image/gif"/><title>VisualizationContainerController.java</title><link rel="stylesheet" href="../../../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../.sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">test (Mar 21, 2014 6:54:09 PM)</a> &gt; <a href="../../index.html" class="el_group">Cryptographics</a> &gt; <a href="../index.html" class="el_bundle">src</a> &gt; <a href="index.source.html" class="el_package">edu.kit.iks.Cryptographics</a> &gt; <span class="el_source">VisualizationContainerController.java</span></div><h1>VisualizationContainerController.java</h1><pre class="source lang-java linenums"><span class="pc" id="L1">package edu.kit.iks.Cryptographics;</span>

import java.awt.AWTEvent;
import java.awt.BorderLayout;
import java.awt.Toolkit;
import java.awt.event.AWTEventListener;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.MouseEvent;
import java.lang.reflect.Constructor;
import java.lang.reflect.InvocationTargetException;
import java.util.List;

import javax.swing.Timer;

import edu.kit.iks.CryptographicsLib.AbstractController;
import edu.kit.iks.CryptographicsLib.AbstractVisualizationController;
import edu.kit.iks.CryptographicsLib.AbstractVisualizationInfo;
import edu.kit.iks.CryptographicsLib.Configuration;
import edu.kit.iks.CryptographicsLib.Logger;
import edu.kit.iks.CryptographicsLib.MouseClickListener;

/**
 * An instance of this class is a wrapper for visualization controller to
 * outsource common UI elements like navigation buttons
 * 
 * @author Christian Dreher
 */
public class VisualizationContainerController extends AbstractController {

	/**
	 * Index of the current {VisualizationController} in {childControllers}-list
	 */
	private int currentVisualizationControllerIndex;

	/**
	 * List of all visualizationControllers. Behaves like a cache and will be
	 * filled on demand
	 */
	private AbstractVisualizationController[] visualizationControllers;

	/**
	 * {VisualizationInfo}-object holding metadata of the procuedure
	 */
	private AbstractVisualizationInfo visualizationInfo;

	/**
	 * Container to display the actual visualization of a procedure
	 */
	private VisualizationContainerView view;
	
	/**
	 * The timer used to detect an idle user. This is used to figure out when to
	 * present the idle popover, so it's step 1.
	 */
	private Timer idleDetectionTimer;
	
	/**
	 * The timer used to reset the state. This is step two of the idle detection.
	 */
	private Timer resetTimer;
	
	/**
	 * The global event listener used for detecting an idle user.
	 */
	private AWTEventListener idleDetectionListener;
	
	/**
	 * The popover presented to warn the user before going back to the main screen.
	 */
	private IdlePopoverView idlePopoverView;

	/**
	 * List of all child classes
	 */
	@SuppressWarnings(&quot;rawtypes&quot;)
	List&lt;Class&gt; childClasses;
	
	/**
	 * View of the popover wich shows help for the user.
	 */
	private HelpPopoverView helpPopoverView;

	/**
	 * Constructor initializing a new instance of
	 * {VisualizationContainerController}
	 * 
	 * @param visualizationInfo
	 *            Object of {VisualizationInfo} containing the data to
	 *            instantiate related controllers from
	 */
<span class="fc" id="L92">	public VisualizationContainerController(</span>
			AbstractVisualizationInfo visualizationInfo) {
<span class="fc" id="L94">		this.visualizationInfo = visualizationInfo;</span>
<span class="fc" id="L95">		this.childClasses = this.visualizationInfo.getControllerClasses();</span>
<span class="fc" id="L96">		this.idleDetectionListener = new AWTEventListener() {</span>
			@Override
			public void eventDispatched(AWTEvent e) {
<span class="nc" id="L99">				stopIdleDetectionTimer();</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">				if (idlePopoverView == null) {</span>
<span class="nc" id="L101">					startIdleDetectionTimer();</span>
				}
<span class="nc" id="L103">			}</span>
		};
<span class="fc" id="L105">		this.startIdleDetectionTimer();</span>

		// Create an array that can hold all visualization controllers.
		// The controller's will be instantiated on demand (lazily).
<span class="fc" id="L109">		this.visualizationControllers = new AbstractVisualizationController[this.childClasses</span>
<span class="fc" id="L110">				.size()];</span>
<span class="fc" id="L111">	}</span>

	/**
	 * Gets the {VisualizationInfo}-object of the current visualization
	 * 
	 * @return {VizualizationInfo}-object of the current visualization
	 */
	public AbstractVisualizationInfo getVisualizationInfo() {
<span class="fc" id="L119">		return this.visualizationInfo;</span>
	}

	/**
	 * Loads the view
	 */
	@Override
	public void loadView() {
		// Observe global mouse events.
<span class="fc" id="L128">		Toolkit.getDefaultToolkit().addAWTEventListener(this.idleDetectionListener, AWTEvent.MOUSE_MOTION_EVENT_MASK);</span>
		
<span class="fc" id="L130">		this.view = new VisualizationContainerView();</span>
<span class="fc" id="L131">		this.view.setName(&quot;visualization-container-controller-view&quot;);</span>
		// Styling purpose
<span class="fc" id="L133">		this.view.setName(&quot;visualizationContainerController&quot;);</span>
<span class="fc" id="L134">		this.view.getNameLabel().setText(&quot;&lt;html&gt;&lt;h1&gt;&quot; + this.getVisualizationInfo().getName() + &quot;&lt;/h1&gt;&lt;/html&gt;&quot;);</span>
		
<span class="fc" id="L136">		this.view.getExitButton().addMouseListener(new MouseClickListener() {</span>
			@Override
			public void clicked(MouseEvent e) {
<span class="nc" id="L139">				MainController mainController = (MainController) getParentController();</span>
<span class="nc" id="L140">				getCurrentVisualizationController().unloadView();</span>
<span class="nc" id="L141">				Logger.log(&quot;User went back to start screen&quot;);</span>
<span class="nc" id="L142">				mainController.presentStartAction();</span>
<span class="nc" id="L143">			}</span>
		});
<span class="fc" id="L145">		this.view.getHelpButton().addMouseListener(new MouseClickListener() {</span>
			@Override
			public void clicked(MouseEvent e) {
<span class="nc" id="L148">				presentHelpPopover();</span>
<span class="nc" id="L149">			}</span>
		});
<span class="fc" id="L151">	}</span>

	/**
	 * Unloads the view
	 */
	@Override
	public void unloadView() {
		// Remove observer.
<span class="fc" id="L159">		Toolkit.getDefaultToolkit().removeAWTEventListener(this.idleDetectionListener);</span>
		
		// Stop timers.
<span class="fc" id="L162">		this.stopIdleDetectionTimer();</span>
<span class="fc" id="L163">		this.stopResetTimer();</span>
		
<span class="pc bpc" id="L165" title="1 of 2 branches missed.">		if (this.helpPopoverView != null) {</span>
<span class="nc" id="L166">			this.dismissHelpPopover();</span>
		}
		
<span class="pc bpc" id="L169" title="1 of 2 branches missed.">		if (this.idlePopoverView != null) {</span>
<span class="nc" id="L170">			this.dismissIdlePopover();</span>
		}
		
<span class="fc" id="L173">		this.view.removeAll();</span>
<span class="fc" id="L174">		this.view.revalidate();</span>
		
<span class="fc" id="L176">		this.helpPopoverView = null;</span>
<span class="fc" id="L177">		this.idlePopoverView = null;</span>
<span class="fc" id="L178">		this.view = null;</span>
<span class="fc" id="L179">	}</span>

	/**
	 * Gets the view
	 */
	@Override
	public VisualizationContainerView getView() {
<span class="fc" id="L186">		return this.view;</span>
	}
	
	/**
	 * Creates and presents a new idle popover. The idle popover is presented
	 * after the program things that the user is idle. It displays a count-down
	 * after which it resets itself.  
	 */
	public void presentIdlePopover() {
<span class="nc bnc" id="L195" title="All 2 branches missed.">		if (this.helpPopoverView != null) {</span>
<span class="nc" id="L196">			this.dismissHelpPopover();</span>
		}
<span class="nc bnc" id="L198" title="All 2 branches missed.">		if (this.idlePopoverView != null) {</span>
<span class="nc" id="L199">			this.dismissIdlePopover();</span>
		}
		
		// Create popover.
<span class="nc" id="L203">		this.idlePopoverView = new IdlePopoverView(Configuration.getInstance().getResetTimeout());</span>
<span class="nc" id="L204">		this.idlePopoverView.present(this.getView().getExitButton());</span>
		
		// Create mouse listeners for buttons.
<span class="nc" id="L207">		MouseClickListener listener = new MouseClickListener() {</span>
			@Override
			public void clicked(MouseEvent e) {
<span class="nc" id="L210">				dismissIdlePopover();</span>
<span class="nc" id="L211">				startIdleDetectionTimer();</span>
<span class="nc" id="L212">			}</span>
		};
<span class="nc" id="L214">		this.idlePopoverView.getCloseButton().addMouseListener(listener);</span>
<span class="nc" id="L215">		this.idlePopoverView.getContinueButton().addMouseListener(listener);</span>
		
<span class="nc" id="L217">		this.startResetTimer();</span>
<span class="nc" id="L218">	}</span>
	
	/**
	 * Dismisses the active idle popover.
	 */
	public void dismissIdlePopover() {
<span class="nc" id="L224">		this.idlePopoverView.dismiss();</span>
<span class="nc" id="L225">		this.idlePopoverView = null;</span>
<span class="nc" id="L226">		this.stopResetTimer();</span>
<span class="nc" id="L227">	}</span>
	
	/**
	 * Stops the reset timer.
	 */
	private void stopResetTimer() {
<span class="pc bpc" id="L233" title="1 of 2 branches missed.">		if (this.resetTimer != null) {</span>
<span class="nc" id="L234">			this.resetTimer.stop();</span>
<span class="nc" id="L235">			this.resetTimer = null;</span>
		}
<span class="fc" id="L237">	}</span>
	
	/**
	 * Starts the reset timer. After the timer fires, the program
	 * will present the start controller.
	 */
	private void startResetTimer() {
<span class="nc bnc" id="L244" title="All 2 branches missed.">		if (this.resetTimer == null) {</span>
<span class="nc" id="L245">			int delay = Configuration.getInstance().getResetTimeout();</span>
<span class="nc" id="L246">			this.resetTimer = new Timer(delay, new ActionListener() {</span>

				@Override
				public void actionPerformed(ActionEvent arg0) {
<span class="nc" id="L250">					stopResetTimer();</span>
					
<span class="nc" id="L252">					MainController mainController = (MainController) getParentController();</span>
<span class="nc" id="L253">					mainController.presentStartAction();</span>
<span class="nc" id="L254">					Logger.log(&quot;Reset due to user inactivity&quot;);</span>
<span class="nc" id="L255">				}</span>
				
			});
<span class="nc" id="L258">			this.resetTimer.start();</span>
		}
<span class="nc" id="L260">	}</span>
	
	/**
	 * Stops an idle detection timer.
	 */
	private void stopIdleDetectionTimer() {
<span class="pc bpc" id="L266" title="1 of 2 branches missed.">		if (this.idleDetectionTimer != null) {</span>
<span class="fc" id="L267">			this.idleDetectionTimer.stop();</span>
<span class="fc" id="L268">			this.idleDetectionTimer = null;</span>
		}
<span class="fc" id="L270">	}</span>
	
	/**
	 * Starts the idle detection timer. The idle detection fires if a user
	 * doesn't perform any input for a given period of time.
	 */
	private void startIdleDetectionTimer() {
<span class="pc bpc" id="L277" title="1 of 2 branches missed.">		if (this.idleDetectionTimer == null) {</span>
			// Create a new timer if the idle popover is currently not already active.
<span class="fc" id="L279">			int delay = Configuration.getInstance().getIdleTimeout();</span>
<span class="fc" id="L280">			this.idleDetectionTimer = new Timer(delay, new ActionListener() {</span>

				@Override
				public void actionPerformed(ActionEvent e) {
<span class="nc" id="L284">					stopIdleDetectionTimer();</span>
<span class="nc" id="L285">					presentIdlePopover();</span>
<span class="nc" id="L286">				}</span>
			});
<span class="fc" id="L288">			this.idleDetectionTimer.start();</span>
		}
<span class="fc" id="L290">	}</span>

	/**
	 * Shows a popover displaying given help.
	 * 
	 */
	public void presentHelpPopover() {
<span class="nc bnc" id="L297" title="All 2 branches missed.">		if (this.helpPopoverView != null) {</span>
<span class="nc" id="L298">			this.dismissHelpPopover();</span>
		}
<span class="nc bnc" id="L300" title="All 2 branches missed.">		if (this.idlePopoverView != null) {</span>
<span class="nc" id="L301">			this.dismissIdlePopover();</span>
		}
		
<span class="nc" id="L304">		String helpText = this.getCurrentVisualizationController().getHelp();</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">		if (helpText == null) {</span>
			// Do not present help if no help is available.
<span class="nc" id="L307">			return;</span>
		}
		
<span class="nc" id="L310">		this.helpPopoverView = new HelpPopoverView(helpText);</span>
<span class="nc" id="L311">		this.helpPopoverView.getCloseButton().addMouseListener(new MouseClickListener() {</span>
			@Override
			public void clicked(MouseEvent e) {
<span class="nc" id="L314">				dismissHelpPopover();</span>
<span class="nc" id="L315">			}</span>
		});
<span class="nc" id="L317">		this.helpPopoverView.present(this.getView().getHelpButton());</span>
<span class="nc" id="L318">	}</span>
	
	/**
	 * Function for unloading the helpView.
	 */
	public void dismissHelpPopover() {
<span class="nc" id="L324">		this.helpPopoverView.dismiss();</span>
<span class="nc" id="L325">		this.helpPopoverView = null;</span>
<span class="nc" id="L326">	}</span>

	/**
	 * Sets the current visualizationController with given index
	 * 
	 * @param index
	 *            Index of the VisualizationController inside
	 *            {visualizationControllers}-array
	 */
	public void setCurrentVisualizationControllerIndex(int index) {
<span class="fc" id="L336">		AbstractVisualizationController oldController = this</span>
<span class="fc" id="L337">				.getCurrentVisualizationController();</span>
<span class="pc bpc" id="L338" title="1 of 2 branches missed.">		if (oldController != null) {</span>
<span class="nc" id="L339">			this.removeChildController(oldController);</span>

			// Remove view
<span class="nc" id="L342">			this.getView().getContentView().remove(oldController.getView());</span>
<span class="nc" id="L343">			oldController.unloadView();</span>
		}

		// Load new controller if necessary.
<span class="fc" id="L347">		AbstractVisualizationController newController = this.visualizationControllers[index];</span>
<span class="pc bpc" id="L348" title="1 of 2 branches missed.">		if (newController == null) {</span>
<span class="fc" id="L349">			newController = this.loadVisualizationController(index);</span>
		}

		// Set new controller
<span class="fc" id="L353">		this.currentVisualizationControllerIndex = index;</span>
<span class="fc" id="L354">		this.addChildController(newController);</span>

		// Load new view
<span class="fc" id="L357">		newController.loadView();</span>
<span class="fc" id="L358">		this.getView().getContentView().add(newController.getView(), BorderLayout.CENTER);</span>
<span class="fc" id="L359">		this.getView().revalidate();</span>
<span class="fc" id="L360">	}</span>

	/**
	 * Gets the current {VisualizationController}
	 * 
	 * @return Current {VisualizationController}
	 */
	public AbstractVisualizationController getCurrentVisualizationController() {
<span class="fc" id="L368">		return this.visualizationControllers[this.currentVisualizationControllerIndex];</span>
	}

	/**
	 * Checks, whether this controller has a next {VisualizationController} or
	 * not
	 * 
	 * @return {true}, if this controller has a next {VisualizationController},
	 *         {false} if not
	 */
	public boolean hasNextVisualizationController() {
<span class="nc bnc" id="L379" title="All 2 branches missed.">		return (this.currentVisualizationControllerIndex &lt; childClasses.size() - 1);</span>
	}

	/**
	 * Presents the next {VisualizationController}
	 */
	public void presentNextVisualizationController() {
<span class="nc" id="L386">		this.setCurrentVisualizationControllerIndex(this.currentVisualizationControllerIndex + 1);</span>
<span class="nc" id="L387">	}</span>

	/**
	 * Checks, whether this controller has a previous {VisualizationController}
	 * or not
	 * 
	 * @return {true}, if this controller has a previous
	 *         {VisualizationController}, {false} if not
	 */
	public boolean hasPreviousVisualizationController() {
<span class="nc bnc" id="L397" title="All 2 branches missed.">		return (this.currentVisualizationControllerIndex &gt; 1);</span>
	}

	/**
	 * Presents the previous {VisualizationController}
	 */
	public void presentPreviousVisualizationController() {
<span class="nc" id="L404">		this.setCurrentVisualizationControllerIndex(this.currentVisualizationControllerIndex - 1);</span>
<span class="nc" id="L405">	}</span>

	/**
	 * Loads the {VisualizationController} with given {index}
	 * 
	 * @param index
	 *            Index of the {VisualizationController} inside
	 *            {visualizationControllers}-array
	 * @return The just loaded {VisualizationController}
	 */
	private AbstractVisualizationController loadVisualizationController(
			int index) {
<span class="fc" id="L417">		Constructor&lt;AbstractVisualizationController&gt; controllerConstructor = null;</span>
		@SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L419">		Class&lt;AbstractVisualizationController&gt; controllerClass = childClasses</span>
<span class="fc" id="L420">				.get(index);</span>
<span class="fc" id="L421">		AbstractVisualizationController controller = null;</span>

		try {
			// visualizationinfo is now passed to the contructor.
<span class="fc" id="L425">			controllerConstructor = controllerClass</span>
<span class="fc" id="L426">					.getConstructor(AbstractVisualizationInfo.class);</span>
<span class="fc" id="L427">			controller = controllerConstructor</span>
<span class="fc" id="L428">					.newInstance(this.visualizationInfo);</span>
<span class="fc" id="L429">		} catch (InstantiationException | IllegalAccessException</span>
				| NoSuchMethodException | SecurityException
<span class="nc" id="L431">				| IllegalArgumentException | InvocationTargetException e) {</span>
<span class="nc" id="L432">			Logger.error(e);</span>
		}

<span class="fc" id="L435">		this.visualizationControllers[index] = controller;</span>
<span class="fc" id="L436">		return controller;</span>
	}

	/**
	 * Presents the start controller
	 */
	public void presentStartController() {
<span class="nc bnc" id="L443" title="All 2 branches missed.">		if (this.helpPopoverView != null) {</span>
<span class="nc" id="L444">			this.dismissHelpPopover();</span>
		}
		
<span class="nc" id="L447">		MainController mainController = (MainController) this</span>
<span class="nc" id="L448">				.getParentController();</span>
<span class="nc" id="L449">		mainController.presentStartAction();</span>
<span class="nc" id="L450">	}</span>
	
	/**
	 * @return the helpView
	 */
	public HelpPopoverView getHelpPopoverView() {
<span class="fc" id="L456">		return helpPopoverView;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.0.201403182114</span>test (Mar 21, 2014 6:54:09 PM)</div></body></html>