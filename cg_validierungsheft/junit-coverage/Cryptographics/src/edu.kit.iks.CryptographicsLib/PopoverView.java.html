<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../.resources/report.gif" type="image/gif"/><title>PopoverView.java</title><link rel="stylesheet" href="../../../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../.sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">test (Mar 21, 2014 6:54:09 PM)</a> &gt; <a href="../../index.html" class="el_group">Cryptographics</a> &gt; <a href="../index.html" class="el_bundle">src</a> &gt; <a href="index.source.html" class="el_package">edu.kit.iks.CryptographicsLib</a> &gt; <span class="el_source">PopoverView.java</span></div><h1>PopoverView.java</h1><pre class="source lang-java linenums"><span class="nc" id="L1">package edu.kit.iks.CryptographicsLib;</span>

import java.awt.BasicStroke;
import java.awt.Color;
import java.awt.Dimension;
import java.awt.Graphics;
import java.awt.Graphics2D;
import java.awt.GridBagConstraints;
import java.awt.GridBagLayout;
import java.awt.Insets;
import java.awt.Point;
import java.awt.Rectangle;
import java.awt.RenderingHints;
import java.awt.geom.Area;
import java.awt.geom.GeneralPath;
import java.awt.geom.RoundRectangle2D;

import javax.swing.BorderFactory;
import javax.swing.JButton;
import javax.swing.JComponent;
import javax.swing.JPanel;
import javax.swing.border.Border;

/**
 * An instance of this class represents the view of a popover
 * 
 * @author Christian Dreher
 */
public class PopoverView extends JPanel {
	/**
	 * Defines the possible locations of a popover arrow. 
	 */
<span class="nc" id="L33">	private enum ArrowLocation {</span>
<span class="nc" id="L34">	    TOP, BOTTOM </span>
	};
	
	/**
	 * The width of the arrow.
	 */
	final private static int ARROW_WIDTH = 40;
	
	/**
	 * The height of the arrow.
	 */
	final private static int ARROW_HEIGHT = 20;
	
	/**
	 * The inner inset of the popover.
	 */
	final private static int INSET = 20;
	
	/**
	 * The corner radius of the popover.
	 */
	final private static int CORNER_RADIUS = 20;
	
	/**
	 * The minimum padding between the container and the popover.
	 */
	final private static int MINIMUM_CONTAINER_PADDING = 5;
	
	private Color borderColor;
	
	/**
	 * The arrow location of the popover.
	 */
<span class="nc" id="L67">	private ArrowLocation arrowLocation = ArrowLocation.TOP;</span>
	
	/**
	 * Serial Version UID
	 */
	private static final long serialVersionUID = -5949014143695648861L;

	/**
	 * Button to close the popover
	 */
	private JButton closeButton;
	
	/**
	 * Content area of the popover
	 */
	private JPanel contentView;
	
	private Point anchorPoint;
	
	/**
	 * The shared container view
	 */
	static private JPanel containerView;
	
	/**
	 * Constructor initializing a new instance of {PopoverView}
	 */
	public PopoverView() {
<span class="nc" id="L95">		super(new GridBagLayout());</span>
		
<span class="nc" id="L97">		this.setOpaque(false);</span>
<span class="nc" id="L98">		this.setMaximumSize(new Dimension(500, 500));</span>
<span class="nc" id="L99">		this.setBackground(new Color(250, 250, 250, 230));</span>
<span class="nc" id="L100">		this.setBorderColor(Color.LIGHT_GRAY);</span>
		
		// Create close button.
<span class="nc" id="L103">		GridBagConstraints closeConstraints = new GridBagConstraints();</span>
<span class="nc" id="L104">		closeConstraints.gridx = 0;</span>
<span class="nc" id="L105">		closeConstraints.gridy = 0;</span>
<span class="nc" id="L106">		closeConstraints.insets = new Insets(0, 0, 0, 0);</span>
		// \u00D7 is the unicode for the times &quot;x&quot; (prettier close icon as just x)
<span class="nc" id="L108">		this.closeButton = new JButton(&quot;\u00D7&quot;);</span>
		// Name to enable applying custom style with synth
<span class="nc" id="L110">		this.closeButton.setName(&quot;closeButton&quot;);</span>
<span class="nc" id="L111">		this.add(this.closeButton, closeConstraints);</span>
		
		// Create content view.
<span class="nc" id="L114">		GridBagConstraints contentConstraints = new GridBagConstraints();</span>
<span class="nc" id="L115">		contentConstraints.gridx = 0;</span>
<span class="nc" id="L116">		contentConstraints.gridy = 1;</span>
<span class="nc" id="L117">		contentConstraints.gridwidth = 3;</span>
<span class="nc" id="L118">		contentConstraints.insets = new Insets(0, INSET, INSET, INSET);</span>
<span class="nc" id="L119">		this.contentView = new JPanel();</span>
<span class="nc" id="L120">		this.contentView.setOpaque(false);</span>
<span class="nc" id="L121">		this.add(this.contentView, contentConstraints);</span>
		
<span class="nc" id="L123">		this.validate();</span>
<span class="nc" id="L124">	}</span>
	
	/**
	 * Returns the CloseButton.
	 * 
	 * @return the closeButton button to return.
	 */
	public JButton getCloseButton() {
<span class="nc" id="L132">		return this.closeButton;</span>
	}
	
	/**
	 * The content view contains the popover's content. This makes it easier to
	 * layout the popover and the content properly.
	 * 
	 * @return the content view.
	 */
	public JPanel getContentView() {
<span class="nc" id="L142">		return this.contentView;</span>
	}
	
	/**
	 * Configures all popovers to use a given container view. The container view
	 * should be visible above all other components and should have maximum height
	 * and width. You cannot use popover views before configuring them without a container!
	 * 
	 * @param containerView the container view
	 */
	public static void setContainerView(JPanel containerView) {
<span class="fc" id="L153">		PopoverView.containerView = containerView;</span>
		
		// Configure container.
<span class="fc" id="L156">		containerView.setLayout(null);</span>
<span class="fc" id="L157">		containerView.setVisible(true);</span>
<span class="fc" id="L158">	}</span>
	
	/**
	 * Presents a popover in the container
	 * 
	 * @param originComponent the origin of the popover is where the arrow of the popover should point to
	 */
	public void present(JComponent anchorComponent) {
<span class="nc" id="L166">		this.validate();</span>
		
		// Calculate the anchorPoint. The origin is in the center of the component.
<span class="nc" id="L169">		double x = anchorComponent.getLocationOnScreen().getX() - PopoverView.containerView.getLocationOnScreen().getX();</span>
<span class="nc" id="L170">		x += anchorComponent.getSize().getWidth() / 2;</span>
<span class="nc" id="L171">		double y = anchorComponent.getLocationOnScreen().getY() - PopoverView.containerView.getLocationOnScreen().getY();</span>
<span class="nc" id="L172">		y += anchorComponent.getSize().getHeight() / 2;</span>
<span class="nc" id="L173">		this.anchorPoint = new Point((int)x, (int)y);</span>
		
		// Position in container view.
<span class="nc" id="L176">		PopoverView.containerView.add(this);</span>
<span class="nc" id="L177">		PopoverView.containerView.validate();</span>
		
<span class="nc" id="L179">		this.prepareForPresentation();</span>
<span class="nc" id="L180">	}</span>
	
	/**
	 * Removes a popover from the container
	 */
	public void dismiss() {
<span class="nc" id="L186">		PopoverView.containerView.remove(this);</span>
<span class="nc" id="L187">		PopoverView.containerView.revalidate();</span>
<span class="nc" id="L188">		PopoverView.containerView.repaint();</span>
<span class="nc" id="L189">	}</span>
	
	/**
	 * Paints the popover.
	 */
	@Override
	protected void paintComponent(Graphics g) {
<span class="nc" id="L196">        super.paintComponent(g);</span>
        
<span class="nc" id="L198">        final Area shape = this.createShape();</span>
<span class="nc" id="L199">        Graphics2D g2d = (Graphics2D)g;</span>
<span class="nc" id="L200">        g2d.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);</span>
<span class="nc" id="L201">        g2d.setRenderingHint(RenderingHints.KEY_FRACTIONALMETRICS, RenderingHints.VALUE_FRACTIONALMETRICS_OFF);</span>
        
        // Fill.
<span class="nc" id="L204">        g2d.setPaint(this.getBackground());</span>
<span class="nc" id="L205">        g2d.fill(shape);</span>
        
        // Stroke.
<span class="nc" id="L208">        g2d.setStroke(new BasicStroke(1.0f, BasicStroke.CAP_ROUND, BasicStroke.JOIN_ROUND));</span>
<span class="nc" id="L209">        g2d.setPaint(this.getBorderColor());</span>
<span class="nc" id="L210">        g2d.draw(shape);</span>
<span class="nc" id="L211">    }</span>

	/**
	 * Creates the popover shape
	 * @return The popover shape
	 */
	private Area createShape() {
<span class="nc" id="L218">		final Insets insets = new Insets(1, 1, 1, 1);</span>
<span class="nc" id="L219">		Rectangle bounds = this.getBounds();</span>
<span class="nc" id="L220">		bounds.x += insets.left;</span>
<span class="nc" id="L221">		bounds.y += insets.top;</span>
<span class="nc" id="L222">		bounds.width -= insets.left + insets.right;</span>
<span class="nc" id="L223">		bounds.height -= insets.top + insets.bottom;</span>
		
		// Create the basic rounded shape.
<span class="nc" id="L226">		Area shape = null;</span>
<span class="nc bnc" id="L227" title="All 3 branches missed.">		switch (this.arrowLocation) {</span>
			case TOP:
<span class="nc" id="L229">				shape = new Area(new RoundRectangle2D.Double(insets.left, insets.top + ARROW_HEIGHT, bounds.getWidth(), bounds.getHeight() - ARROW_HEIGHT, CORNER_RADIUS, CORNER_RADIUS));</span>
<span class="nc" id="L230">				break;</span>
				
			case BOTTOM:
<span class="nc" id="L233">				shape = new Area(new RoundRectangle2D.Double(insets.left, insets.top, bounds.getWidth(), bounds.getHeight() - ARROW_HEIGHT, CORNER_RADIUS, CORNER_RADIUS));</span>
				break;
		}
		
		// Calculate the offset for the arrow.
<span class="nc" id="L238">		int centerLocationX = (int)(this.getLocation().getX() + (insets.left + bounds.getWidth()) / 2); </span>
<span class="nc" id="L239">		int offsetX = (int)(this.anchorPoint.getX() - centerLocationX);</span>
		
		// Create the arrow path.
<span class="nc" id="L242">	    GeneralPath path = new GeneralPath(GeneralPath.WIND_EVEN_ODD);</span>
<span class="nc" id="L243">	    Point arrowLocation = null;</span>
<span class="nc bnc" id="L244" title="All 3 branches missed.">	    switch (this.arrowLocation) {</span>
			case TOP:
<span class="nc" id="L246">				arrowLocation = new Point((int)((insets.left + bounds.width) / 2 + offsetX), insets.top + ARROW_HEIGHT);</span>
<span class="nc" id="L247">				path.moveTo(arrowLocation.getX() - ARROW_WIDTH / 2, arrowLocation.getY());</span>
<span class="nc" id="L248">				path.lineTo(arrowLocation.getX(), arrowLocation.getY() - ARROW_HEIGHT);</span>
<span class="nc" id="L249">			    path.lineTo(arrowLocation.getX() + ARROW_WIDTH / 2, arrowLocation.getY());</span>
<span class="nc" id="L250">			    break;</span>
				
			case BOTTOM:
<span class="nc" id="L253">				arrowLocation = new Point((int)((insets.left + bounds.width) / 2 + offsetX), (int)(insets.top + bounds.height - ARROW_HEIGHT));</span>
<span class="nc" id="L254">				path.moveTo(arrowLocation.getX() - ARROW_WIDTH / 2, arrowLocation.getY());</span>
<span class="nc" id="L255">				path.lineTo(arrowLocation.getX(), arrowLocation.getY() + ARROW_HEIGHT);</span>
<span class="nc" id="L256">			    path.lineTo(arrowLocation.getX() + ARROW_WIDTH / 2, arrowLocation.getY());</span>
			    break;
	    }
<span class="nc" id="L259">	    path.closePath();</span>
<span class="nc" id="L260">	    shape.add(new Area(path));</span>

<span class="nc" id="L262">	    return shape;</span>
	}
	
	/**
	 * Prepares a popover for presentation by calculation its bounds and the proper
	 * arrow location. 
	 */
	private void prepareForPresentation() {
<span class="nc" id="L270">		Dimension containerSize = PopoverView.containerView.getSize();</span>
<span class="nc" id="L271">		Point center = new Point((int)(containerSize.getWidth() / 2), (int)(containerSize.getHeight() / 2));</span>
<span class="nc" id="L272">		double offsetY = center.getY() - this.anchorPoint.getY();</span>
		
		// Figure out arrow location.
<span class="nc bnc" id="L275" title="All 2 branches missed.">		if (offsetY &lt; 0.0) {</span>
<span class="nc" id="L276">			this.arrowLocation = ArrowLocation.BOTTOM;</span>
<span class="nc" id="L277">		} else {</span>
<span class="nc" id="L278">			this.arrowLocation = ArrowLocation.TOP;</span>
		}
		
<span class="nc" id="L281">		this.updateBorder();</span>
<span class="nc" id="L282">		this.updateBounds();</span>
<span class="nc" id="L283">		this.repaint();</span>
<span class="nc" id="L284">	}</span>
	
	/**
	 * We use a border to account for the arrow. 
	 */
	private void updateBorder() {
		Border border;
<span class="nc bnc" id="L291" title="All 3 branches missed.">		switch (this.arrowLocation) {</span>
<span class="nc" id="L292">			case TOP: border = BorderFactory.createEmptyBorder(ARROW_HEIGHT, 0, 0, 0); break;</span>
<span class="nc" id="L293">			case BOTTOM: border = BorderFactory.createEmptyBorder(0, 0, ARROW_HEIGHT, 0); break;</span>
<span class="nc" id="L294">			default: border = BorderFactory.createEmptyBorder(0, 0, 0, 0); break;</span>
		}
		
<span class="nc" id="L297">		this.setBorder(border);</span>
<span class="nc" id="L298">	}</span>
	
	/**
	 * Updates the bounds of the popover.
	 */
	private void updateBounds() {
<span class="nc" id="L304">		Dimension size = this.getPreferredSize();</span>
		
		// First, try to align the popover horizontally centered to the anchor.
		Point location;
<span class="nc bnc" id="L308" title="All 3 branches missed.">		switch (this.arrowLocation) {</span>
			case TOP:
<span class="nc" id="L310">				location = new Point((int)(this.anchorPoint.getX() - size.getWidth() / 2), (int)this.anchorPoint.getY());</span>
<span class="nc" id="L311">				break;</span>
				
			case BOTTOM:
<span class="nc" id="L314">				location = new Point((int)(this.anchorPoint.getX() - size.getWidth() / 2), (int)(this.anchorPoint.getY() - size.getHeight()));</span>
<span class="nc" id="L315">				break;</span>
				
			default:
<span class="nc" id="L318">				location = new Point(0, 0);</span>
				break;
		}
<span class="nc" id="L321">		Rectangle bounds = new Rectangle(location, size);</span>
		
		// Check if the bounds fit into the container.
<span class="nc" id="L324">		Rectangle containerBounds = PopoverView.containerView.getBounds();</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">		if (!containerBounds.contains(bounds)) {</span>
<span class="nc bnc" id="L326" title="All 2 branches missed.">			if (bounds.getX() &lt; MINIMUM_CONTAINER_PADDING) {</span>
<span class="nc" id="L327">				bounds.setLocation(MINIMUM_CONTAINER_PADDING, (int)bounds.getY());</span>
<span class="nc bnc" id="L328" title="All 2 branches missed.">			} else if (bounds.getX() + bounds.getWidth() &gt; containerBounds.getWidth() - MINIMUM_CONTAINER_PADDING) {</span>
<span class="nc" id="L329">				bounds.setLocation((int)(containerBounds.getWidth() - MINIMUM_CONTAINER_PADDING - bounds.getWidth()), (int)bounds.getY());</span>
			}
		}
		
<span class="nc" id="L333">		this.setBounds(bounds);</span>
<span class="nc" id="L334">	}</span>
	
	/**
	 * Sets the border color.
	 * 
	 * @param color The border color
	 */
	public void setBorderColor(Color color) {
<span class="nc" id="L342">		this.borderColor = color;</span>
<span class="nc" id="L343">		this.repaint();</span>
<span class="nc" id="L344">	}</span>
	
	/**
	 * Gets the border color.
	 * 
	 * @return The border color
	 */
	public Color getBorderColor() {
<span class="nc" id="L352">		return this.borderColor;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.0.201403182114</span>test (Mar 21, 2014 6:54:09 PM)</div></body></html>